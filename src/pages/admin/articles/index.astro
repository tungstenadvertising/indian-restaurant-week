---
/**
 * Admin Articles List Page
 * Displays all articles with filtering and management options
 */
import AdminLayout from '../../../components/admin/AdminLayout.astro';

const apiUrl = import.meta.env.PUBLIC_API_URL || '';
const apiKey = import.meta.env.PUBLIC_ADMIN_API_KEY || 'irw-admin-secret-2024';
---

<AdminLayout title="Articles" activeSection="articles">
  <div class="articles-page">
    <!-- Header -->
    <div class="page-header">
      <div class="header-left">
        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all">All</button>
          <button class="filter-tab" data-filter="published">Published</button>
          <button class="filter-tab" data-filter="draft">Drafts</button>
        </div>
      </div>
      <a href="/admin/articles/new" class="btn-primary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        New Article
      </a>
    </div>

    <!-- Search -->
    <div class="search-bar">
      <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      <input type="text" id="search-input" placeholder="Search articles..." class="search-input">
    </div>

    <!-- Articles List -->
    <div class="articles-list" id="articles-list">
      <div class="loading-state">Loading articles...</div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
      </svg>
      <h3>No articles found</h3>
      <p>Get started by creating your first article.</p>
      <a href="/admin/articles/new" class="btn-primary">Create Article</a>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="delete-modal" style="display: none;">
    <div class="modal">
      <h3>Delete Article</h3>
      <p>Are you sure you want to delete this article? This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn-cancel" id="cancel-delete">Cancel</button>
        <button class="btn-danger" id="confirm-delete">Delete</button>
      </div>
    </div>
  </div>
</AdminLayout>

<style is:global>
  .articles-page {
    max-width: 1200px;
  }

  /* Header */
  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .filter-tabs {
    display: flex;
    background: white;
    border-radius: 0.5rem;
    padding: 0.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .filter-tab {
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    color: #64748b;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border-radius: 0.375rem;
    transition: all 0.2s;
  }

  .filter-tab:hover {
    color: #1e293b;
  }

  .filter-tab.active {
    background: #f59e0b;
    color: white;
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
  }

  .btn-primary svg {
    width: 18px;
    height: 18px;
  }

  /* Search */
  .search-bar {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: #9ca3af;
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.75rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: #f59e0b;
  }

  /* Articles List */
  .articles-list {
    background: white;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .loading-state {
    padding: 3rem;
    text-align: center;
    color: #64748b;
  }

  .article-row {
    display: flex;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    gap: 1.25rem;
    transition: background 0.15s;
  }

  .article-row:last-child {
    border-bottom: none;
  }

  .article-row:hover {
    background: #f8fafc;
  }

  .article-thumb {
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 0.5rem;
    flex-shrink: 0;
  }

  .article-thumb-placeholder {
    width: 80px;
    height: 60px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-radius: 0.5rem;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .article-thumb-placeholder svg {
    width: 24px;
    height: 24px;
    color: white;
    opacity: 0.7;
  }

  .article-info {
    flex: 1;
    min-width: 0;
  }

  .article-title {
    font-weight: 600;
    font-size: 1rem;
    color: #1e293b;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .article-excerpt {
    font-size: 0.875rem;
    color: #64748b;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .article-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .meta-source {
    color: #f59e0b;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .meta-category {
    background: #f1f5f9;
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    color: #64748b;
    font-weight: 500;
  }

  .meta-date {
    color: #94a3b8;
    font-size: 0.8rem;
  }

  .article-status {
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 500;
    flex-shrink: 0;
  }

  .article-status.published {
    background: #d1fae5;
    color: #059669;
  }

  .article-status.draft {
    background: #fef3c7;
    color: #d97706;
  }

  .article-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .btn-action {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.5rem;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
  }

  .btn-edit {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
  }

  .btn-edit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  }

  .btn-delete {
    background: #fef2f2;
    color: #dc2626;
  }

  .btn-delete:hover {
    background: #fee2e2;
  }

  .btn-view {
    background: #f0fdf4;
    color: #16a34a;
  }

  .btn-view:hover {
    background: #dcfce7;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    color: #d1d5db;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    font-size: 1.125rem;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: #64748b;
    margin-bottom: 1.5rem;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .modal {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    max-width: 400px;
    width: 90%;
  }

  .modal h3 {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
  }

  .modal p {
    color: #64748b;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }

  .btn-cancel {
    padding: 0.5rem 1rem;
    background: #f1f5f9;
    border: none;
    border-radius: 0.5rem;
    color: #64748b;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .btn-danger {
    padding: 0.5rem 1rem;
    background: #dc2626;
    border: none;
    border-radius: 0.5rem;
    color: white;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .btn-danger:hover {
    background: #b91c1c;
  }
</style>

<script define:vars={{ apiUrl, apiKey }}>
  const API_URL = apiUrl;
  const API_KEY = apiKey;
  const USE_MOCK = !API_URL;

  let allArticles = [];
  let currentFilter = 'all';
  let deleteId = null;

  async function fetchAdminArticles() {
    const response = await fetch(`${API_URL}/admin/articles`, {
      headers: { 'X-Api-Key': API_KEY }
    });
    if (!response.ok) throw new Error('Failed to fetch');
    return response.json();
  }

  async function deleteArticleApi(id) {
    const response = await fetch(`${API_URL}/admin/articles/${id}`, {
      method: 'DELETE',
      headers: { 'X-Api-Key': API_KEY }
    });
    if (!response.ok) throw new Error('Failed to delete');
    return response.json();
  }

  async function loadArticles() {
    try {
      if (USE_MOCK) {
        // Mock data fallback
        allArticles = [
          { id: '1', title: 'Sample Article', excerpt: 'Sample excerpt', source: 'Test', category: 'News', status: 'draft', date: new Date().toISOString(), sourceUrl: '#' }
        ];
      } else {
        const response = await fetchAdminArticles();
        allArticles = response.articles || [];
      }

      renderArticles();
    } catch (error) {
      console.error('Failed to load articles:', error);
      document.getElementById('articles-list').innerHTML = `
        <div class="loading-state">Failed to load articles: ${error.message}</div>
      `;
    }
  }

  function renderArticles() {
    const listEl = document.getElementById('articles-list');
    const emptyState = document.getElementById('empty-state');
    const searchTerm = document.getElementById('search-input').value.toLowerCase();

    // Filter articles
    let filtered = allArticles;

    if (currentFilter !== 'all') {
      filtered = filtered.filter(a => a.status === currentFilter);
    }

    if (searchTerm) {
      filtered = filtered.filter(a =>
        a.title.toLowerCase().includes(searchTerm) ||
        a.source.toLowerCase().includes(searchTerm) ||
        (a.excerpt || '').toLowerCase().includes(searchTerm)
      );
    }

    if (filtered.length === 0) {
      listEl.style.display = 'none';
      emptyState.style.display = 'block';
      return;
    }

    listEl.style.display = 'block';
    emptyState.style.display = 'none';

    listEl.innerHTML = filtered.map(article => {
      const imgUrl = article.featured_image || article.featuredImage;
      const date = new Date(article.date || article.created_at || article.createdAt).toLocaleDateString();

      return `
        <div class="article-row" data-id="${article.id}">
          ${imgUrl
            ? `<img src="${imgUrl}" alt="" class="article-thumb">`
            : `<div class="article-thumb-placeholder">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                </svg>
              </div>`
          }
          <div class="article-info">
            <div class="article-title">${article.title}</div>
            ${article.excerpt ? `<div class="article-excerpt">${article.excerpt}</div>` : ''}
            <div class="article-meta">
              <span class="meta-category">${article.category}</span>
              <span class="meta-date">${date}</span>
            </div>
          </div>
          <span class="article-status ${article.status}">${article.status}</span>
          <div class="article-actions">
            <a href="${article.sourceUrl || article.source_url || '#'}" target="_blank" class="btn-action btn-view">View</a>
            <a href="/admin/articles/edit?id=${article.id}" class="btn-action btn-edit">Edit</a>
            <button class="btn-action btn-delete" data-id="${article.id}">Delete</button>
          </div>
        </div>
      `;
    }).join('');

    // Attach delete handlers
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        deleteId = e.target.dataset.id;
        document.getElementById('delete-modal').style.display = 'flex';
      });
    });
  }

  // Filter tabs
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentFilter = tab.dataset.filter;
      renderArticles();
    });
  });

  // Search
  document.getElementById('search-input').addEventListener('input', () => {
    renderArticles();
  });

  // Delete modal
  document.getElementById('cancel-delete').addEventListener('click', () => {
    document.getElementById('delete-modal').style.display = 'none';
    deleteId = null;
  });

  document.getElementById('confirm-delete').addEventListener('click', async () => {
    if (!deleteId) return;

    try {
      if (!USE_MOCK) {
        await deleteArticleApi(deleteId);
      }

      // Remove from local array
      allArticles = allArticles.filter(a => a.id !== deleteId);
      renderArticles();

      document.getElementById('delete-modal').style.display = 'none';
      deleteId = null;
    } catch (error) {
      console.error('Failed to delete:', error);
      alert('Failed to delete article');
    }
  });

  // Close modal on overlay click
  document.getElementById('delete-modal').addEventListener('click', (e) => {
    if (e.target.id === 'delete-modal') {
      document.getElementById('delete-modal').style.display = 'none';
      deleteId = null;
    }
  });

  // Load articles
  loadArticles();
</script>
