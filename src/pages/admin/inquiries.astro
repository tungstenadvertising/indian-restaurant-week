---
/**
 * Admin Inquiries Page
 * Displays form submissions from Netlify Forms
 */
import AdminLayout from '../../components/admin/AdminLayout.astro';
---

<AdminLayout title="Inquiries" activeSection="inquiries">
  <div class="inquiries-page">
    <!-- Header -->
    <div class="page-header">
      <div class="header-info">
        <p class="header-desc">Contact form submissions from the website</p>
      </div>
      <button class="btn-refresh" id="refresh-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="refresh-icon">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Refresh
      </button>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-badge">
        <span class="stat-value" id="total-count">-</span>
        <span class="stat-label">Total Inquiries</span>
      </div>
      <div class="stat-badge">
        <span class="stat-value" id="popup-count">-</span>
        <span class="stat-label">From Popup</span>
      </div>
      <div class="stat-badge">
        <span class="stat-value" id="page-count">-</span>
        <span class="stat-label">From Press Room</span>
      </div>
    </div>

    <!-- Submissions Table -->
    <div class="submissions-container">
      <div class="submissions-table" id="submissions-table">
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading submissions...</p>
        </div>
      </div>
    </div>

    <!-- Empty State (hidden by default) -->
    <div class="empty-state" id="empty-state" style="display: none;">
      <div class="empty-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
      </div>
      <h3>No submissions yet</h3>
      <p>Form submissions will appear here once visitors start sending inquiries.</p>
    </div>

    <!-- Error State (hidden by default) -->
    <div class="error-state" id="error-state" style="display: none;">
      <div class="error-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
      </div>
      <h3>Unable to load submissions</h3>
      <p id="error-message">Please check your configuration and try again.</p>
      <button class="btn-retry" id="retry-btn">Try Again</button>
    </div>
  </div>
</AdminLayout>

<style is:global>
  .inquiries-page {
    max-width: 1200px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
  }

  .header-desc {
    color: #64748b;
    font-size: 0.875rem;
  }

  .btn-refresh {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    color: #64748b;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-refresh:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: #1e293b;
  }

  .btn-refresh:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .refresh-icon {
    width: 16px;
    height: 16px;
  }

  .btn-refresh.loading .refresh-icon {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Stats */
  .stats-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-badge {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #f59e0b;
  }

  .stat-label {
    font-size: 0.8rem;
    color: #64748b;
  }

  /* Table Container */
  .submissions-container {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .submissions-table {
    min-height: 200px;
  }

  /* Loading State */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    color: #64748b;
  }

  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e2e8f0;
    border-top-color: #f59e0b;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .empty-icon {
    width: 64px;
    height: 64px;
    background: #f1f5f9;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
  }

  .empty-icon svg {
    width: 32px;
    height: 32px;
    color: #94a3b8;
  }

  .empty-state h3 {
    font-size: 1.125rem;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: #64748b;
    font-size: 0.875rem;
  }

  /* Error State */
  .error-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .error-icon {
    width: 64px;
    height: 64px;
    background: #fef2f2;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
  }

  .error-icon svg {
    width: 32px;
    height: 32px;
    color: #ef4444;
  }

  .error-state h3 {
    font-size: 1.125rem;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .error-state p {
    color: #64748b;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .btn-retry {
    padding: 0.625rem 1.25rem;
    background: #f59e0b;
    border: none;
    border-radius: 0.5rem;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-retry:hover {
    background: #d97706;
  }

  /* Inquiry Row - Expandable like Netlify */
  .inquiry-row {
    border-bottom: 1px solid #f1f5f9;
    transition: background 0.15s;
  }

  .inquiry-row:last-child {
    border-bottom: none;
  }

  .inquiry-row:hover {
    background: #f8fafc;
  }

  /* Header - always visible, clickable */
  .inquiry-header {
    display: flex;
    align-items: center;
    padding: 1rem 1.5rem;
    cursor: pointer;
    gap: 1rem;
  }

  .inquiry-summary {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .inquiry-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1e293b;
  }

  .inquiry-preview {
    color: #64748b;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 500px;
  }

  .inquiry-meta-inline {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-shrink: 0;
  }

  .meta-date {
    color: #94a3b8;
    font-size: 0.8rem;
    white-space: nowrap;
  }

  .expand-icon {
    width: 20px;
    height: 20px;
    color: #94a3b8;
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .inquiry-row.expanded .expand-icon {
    transform: rotate(180deg);
  }

  /* Expanded Details */
  .inquiry-details {
    display: none;
    padding: 0 1.5rem 1.25rem 1.5rem;
    background: #f8fafc;
    border-top: 1px solid #f1f5f9;
  }

  .inquiry-row.expanded .inquiry-details {
    display: block;
  }

  .detail-row {
    display: flex;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e2e8f0;
  }

  .detail-row:last-child {
    border-bottom: none;
  }

  .detail-label {
    width: 100px;
    font-size: 0.8rem;
    color: #64748b;
    flex-shrink: 0;
  }

  .detail-value {
    flex: 1;
    font-size: 0.875rem;
    color: #1e293b;
    line-height: 1.5;
  }

  .detail-value.message {
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* Source Badge */
  .meta-source {
    background: #f1f5f9;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 500;
  }



  .meta-source.page {
    background: #d1fae5;
    color: #059669;
  }

  .meta-source.popup {
    background: #fef3c7;
    color: #d97706;
  }

  /* Detail Actions */
  .detail-actions {
    display: flex;
    justify-content: flex-end;
    padding-top: 1rem;
    margin-top: 0.5rem;
    border-top: 1px solid #e2e8f0;
  }

  .btn-delete {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    background: white;
    border: 1px solid #fecaca;
    border-radius: 0.5rem;
    color: #dc2626;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-delete:hover {
    background: #fef2f2;
    border-color: #f87171;
  }

  /* Deleting state */
  .inquiry-row.deleting {
    opacity: 0.5;
    pointer-events: none;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .inquiry-summary {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }

    .inquiry-preview {
      max-width: 100%;
    }

    .inquiry-meta-inline {
      margin-top: 0.5rem;
    }
  }
</style>

<script>
  const tableEl = document.getElementById('submissions-table');
  const emptyEl = document.getElementById('empty-state');
  const errorEl = document.getElementById('error-state');
  const errorMsgEl = document.getElementById('error-message');
  const refreshBtn = document.getElementById('refresh-btn') as HTMLButtonElement | null;
  const retryBtn = document.getElementById('retry-btn') as HTMLButtonElement | null;

  const totalCountEl = document.getElementById('total-count');
  const popupCountEl = document.getElementById('popup-count');
  const pageCountEl = document.getElementById('page-count');

  // Mock data for local development (used when Netlify function is unavailable)
  const MOCK_SUBMISSIONS = [
    {
      id: '1',
      name: 'Priya Sharma',
      email: 'priya.sharma@timesofindia.com',
      message: 'Hi! I\'m a food journalist with The Times of India and would love to cover Indian Restaurant Week. Can you share more details about participating restaurants and any exclusive chef interviews?',
      source: 'contact-popup',
      ip: '103.42.156.78',
      createdAt: new Date(Date.now() - 1000 * 60 * 30).toISOString() // 30 min ago
    },
    {
      id: '2',
      name: 'Michael Chen',
      email: 'michael@culinarymagazine.com',
      message: 'Interested in partnership opportunities for our culinary magazine. We reach 500k+ readers monthly.',
      source: 'press-room',
      ip: '72.134.201.45',
      createdAt: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString() // 2 hours ago
    },
    {
      id: '3',
      name: 'Sarah Johnson',
      email: 'sarah.j@plantbasedguide.com',
      message: 'Quick question - are there any vegetarian-focused restaurants participating this year? Working on a plant-based dining guide.',
      source: 'contact-popup',
      ip: '184.22.108.92',
      createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString() // 1 day ago
    },
    {
      id: '4',
      name: 'Raj Patel',
      email: 'raj@foodbloggers.network',
      message: 'I represent a group of food bloggers and influencers. We\'d like to discuss potential collaboration for promoting IRW on social media. Our combined reach is over 2 million followers.',
      source: 'contact-popup',
      ip: '49.36.178.214',
      createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 2).toISOString() // 2 days ago
    },
    {
      id: '5',
      name: 'Emily Watson',
      email: 'ewatson@foodandwine.com',
      message: 'Press inquiry: Looking for high-res images and press kit for upcoming feature in Food & Wine magazine.',
      source: 'press-room',
      ip: '66.249.79.12',
      createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 3).toISOString() // 3 days ago
    },
    {
      id: '6',
      name: 'Anonymous',
      email: 'test@example.com',
      message: 'Test submission from homepage',
      source: 'unknown',
      ip: '192.168.1.1',
      createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 5).toISOString() // 5 days ago
    }
  ];

  // Check if we're in local development
  const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

  async function loadSubmissions() {
    // Reset UI
    if (tableEl) tableEl.style.display = 'block';
    if (emptyEl) emptyEl.style.display = 'none';
    if (errorEl) errorEl.style.display = 'none';

    // Show loading
    if (tableEl) {
      tableEl.innerHTML = `
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading submissions...</p>
        </div>
      `;
    }

    // Disable refresh button
    if (refreshBtn) {
      refreshBtn.disabled = true;
      refreshBtn.classList.add('loading');
    }

    try {
      let submissions: any[];
      let total: number;

      // Try to fetch from Netlify function
      const response = await fetch('/.netlify/functions/form-submissions');

      if (response.ok) {
        const data = await response.json();
        submissions = data.submissions;
        total = data.total;
      } else if (isLocalDev) {
        // Use mock data in local development
        console.log('Using mock data for local development');
        submissions = MOCK_SUBMISSIONS;
        total = MOCK_SUBMISSIONS.length;
      } else {
        const data = await response.json();
        throw new Error(data.error || 'Failed to fetch submissions');
      }

      // Update stats
      const popupCount = submissions.filter((s: any) => s.source === 'contact-popup').length;
      const pageCount = submissions.filter((s: any) => s.source === 'press-room').length;

      if (totalCountEl) totalCountEl.textContent = String(total);
      if (popupCountEl) popupCountEl.textContent = String(popupCount);
      if (pageCountEl) pageCountEl.textContent = String(pageCount);

      if (submissions.length === 0) {
        if (tableEl) tableEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
        return;
      }

      // Render table
      renderTable(submissions);

    } catch (error) {
      console.error('Error loading submissions:', error);

      // Fallback to mock data in local dev even on error
      if (isLocalDev) {
        console.log('Fetch failed, using mock data for local development');
        const submissions = MOCK_SUBMISSIONS;
        const popupCount = submissions.filter(s => s.source === 'contact-popup').length;
        const pageCount = submissions.filter(s => s.source === 'press-room').length;

        if (totalCountEl) totalCountEl.textContent = String(submissions.length);
        if (popupCountEl) popupCountEl.textContent = String(popupCount);
        if (pageCountEl) pageCountEl.textContent = String(pageCount);

        renderTable(submissions);
        return;
      }

      if (tableEl) tableEl.style.display = 'none';
      if (errorEl) errorEl.style.display = 'block';
      if (errorMsgEl) {
        errorMsgEl.textContent = error instanceof Error ? error.message : 'Unknown error occurred';
      }

      // Reset stats
      if (totalCountEl) totalCountEl.textContent = '-';
      if (popupCountEl) popupCountEl.textContent = '-';
      if (pageCountEl) pageCountEl.textContent = '-';

    } finally {
      if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('loading');
      }
    }
  }

  function renderTable(submissions: any[]) {
    if (!tableEl) return;

    // Store submissions globally for delete reference
    (window as any).currentSubmissions = submissions;

    const rows = submissions.map((sub, index) => {
      const sourceClass = sub.source === 'contact-popup' ? 'popup' :
                         sub.source === 'press-room' ? 'page' : 'unknown';
      const sourceLabel = sub.source === 'contact-popup' ? 'Popup' :
                         sub.source === 'press-room' ? 'Press Room' : sub.source || 'Unknown';

      const name = sub.name || 'Anonymous';
      const email = sub.email || '';
      const message = sub.message || '';
      const ip = sub.ip || '';
      const preview = message.length > 60 ? message.substring(0, 60) + '...' : message;

      const date = new Date(sub.createdAt);
      const dateStr = date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric'
      });
      const timeStr = date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit'
      });
      const fullDate = date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }) + ' at ' + timeStr;

      return `
        <div class="inquiry-row" data-index="${index}" data-id="${sub.id}">
          <div class="inquiry-header" onclick="toggleInquiry(${index})">
            <div class="inquiry-summary">
              <span class="inquiry-name">${escapeHtml(name)}</span>
              <span class="inquiry-preview">${escapeHtml(preview)}</span>
            </div>
            <div class="inquiry-meta-inline">
              <span class="meta-date">${dateStr}</span>
              <svg class="expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </div>
          </div>
          <div class="inquiry-details">
            <div class="detail-row">
              <span class="detail-label">Name</span>
              <span class="detail-value">${escapeHtml(name)}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Email</span>
              <span class="detail-value">${email ? `<a href="mailto:${escapeHtml(email)}" style="color: #2563eb; text-decoration: none;">${escapeHtml(email)}</a>` : '-'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Message</span>
              <span class="detail-value message">${escapeHtml(message)}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Source</span>
              <span class="detail-value"><span class="meta-source ${sourceClass}">${sourceLabel}</span></span>
            </div>
            <div class="detail-row">
              <span class="detail-label">IP Address</span>
              <span class="detail-value" style="font-family: monospace; color: #64748b;">${ip || '-'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Received</span>
              <span class="detail-value">${fullDate}</span>
            </div>
            <div class="detail-actions">
              <button class="btn-delete" onclick="deleteInquiry('${sub.id}', ${index}, event)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 14px; height: 14px;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Delete
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    tableEl.innerHTML = rows;
  }

  // Toggle expand/collapse
  (window as any).toggleInquiry = (index: number) => {
    const row = document.querySelector(`.inquiry-row[data-index="${index}"]`);
    if (row) {
      row.classList.toggle('expanded');
    }
  };

  // Delete submission
  (window as any).deleteInquiry = async (id: string, index: number, event: Event) => {
    event.stopPropagation(); // Prevent row toggle

    const confirmed = confirm('Are you sure you want to delete this submission? This action cannot be undone.');
    if (!confirmed) return;

    const row = document.querySelector(`.inquiry-row[data-id="${id}"]`);
    if (row) {
      row.classList.add('deleting');
    }

    try {
      // In local dev, just remove from UI
      if (isLocalDev) {
        if (row) row.remove();
        updateStats();
        return;
      }

      const response = await fetch(`/.netlify/functions/form-submissions?id=${id}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        throw new Error('Failed to delete');
      }

      // Remove from UI
      if (row) row.remove();
      updateStats();

    } catch (error) {
      console.error('Error deleting submission:', error);
      alert('Failed to delete submission. Please try again.');
      if (row) row.classList.remove('deleting');
    }
  };

  // Update stats after delete
  function updateStats() {
    const rows = document.querySelectorAll('.inquiry-row');
    const total = rows.length;

    if (totalCountEl) totalCountEl.textContent = String(total);

    // Recount by source from remaining submissions
    const subs = (window as any).currentSubmissions || [];
    const remainingIds = Array.from(rows).map(r => r.getAttribute('data-id'));
    const remainingSubs = subs.filter((s: any) => remainingIds.includes(s.id));

    const popupCount = remainingSubs.filter((s: any) => s.source === 'contact-popup').length;
    const pageCount = remainingSubs.filter((s: any) => s.source === 'press-room').length;

    if (popupCountEl) popupCountEl.textContent = String(popupCount);
    if (pageCountEl) pageCountEl.textContent = String(pageCount);

    // Show empty state if no submissions left
    if (total === 0) {
      if (tableEl) tableEl.style.display = 'none';
      if (emptyEl) emptyEl.style.display = 'block';
    }
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  // Event listeners
  refreshBtn?.addEventListener('click', loadSubmissions);
  retryBtn?.addEventListener('click', loadSubmissions);

  // Initial load
  loadSubmissions();
</script>
