---
/**
 * Admin Dashboard
 * Overview page with stats and quick actions
 */
import AdminLayout from '../../components/admin/AdminLayout.astro';

const apiUrl = import.meta.env.PUBLIC_API_URL || '';
const apiKey = import.meta.env.PUBLIC_ADMIN_API_KEY || 'irw-admin-secret-2024';
---

<AdminLayout title="Dashboard" activeSection="dashboard">
  <div class="dashboard">
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon articles">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-value" id="total-articles">-</div>
          <div class="stat-label">Total Articles</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon published">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-value" id="published-articles">-</div>
          <div class="stat-label">Published</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon drafts">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-value" id="draft-articles">-</div>
          <div class="stat-label">Drafts</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon submissions">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-value" id="recent-submissions-count">-</div>
          <div class="stat-label">New Submissions (7d)</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon categories">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-value" id="categories-count">-</div>
          <div class="stat-label">Categories</div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="section">
      <h2 class="section-title">Quick Actions</h2>
      <div class="actions-grid">
        <a href="/admin/articles/new" class="action-card">
          <div class="action-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
          </div>
          <div class="action-content">
            <div class="action-title">New Article</div>
            <div class="action-desc">Create a new press mention</div>
          </div>
        </a>

        <a href="/admin/articles" class="action-card">
          <div class="action-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
          </div>
          <div class="action-content">
            <div class="action-title">Manage Articles</div>
            <div class="action-desc">View and edit all articles</div>
          </div>
        </a>

        <a href="/media" target="_blank" class="action-card">
          <div class="action-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
          </div>
          <div class="action-content">
            <div class="action-title">View Media Page</div>
            <div class="action-desc">See public news grid</div>
          </div>
        </a>
      </div>
    </div>

    <!-- Recent Articles -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Recent Articles</h2>
        <a href="/admin/articles" class="view-all">View All →</a>
      </div>
      <div class="recent-articles" id="recent-articles">
        <div class="loading">Loading articles...</div>
      </div>
    </div>

    <!-- Recent Submissions -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Recent Submissions</h2>
        <a href="/admin/subscribers" class="view-all">View All →</a>
      </div>
      <div class="recent-submissions" id="recent-submissions">
        <div class="loading">Loading submissions...</div>
      </div>
    </div>
  </div>
</AdminLayout>

<style is:global>
  .dashboard {
    max-width: 1200px;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .stat-icon svg {
    width: 24px;
    height: 24px;
  }

  .stat-icon.articles {
    background: #dbeafe;
    color: #2563eb;
  }

  .stat-icon.published {
    background: #d1fae5;
    color: #059669;
  }

  .stat-icon.drafts {
    background: #fef3c7;
    color: #d97706;
  }

  .stat-icon.categories {
    background: #ede9fe;
    color: #7c3aed;
  }

  .stat-icon.submissions {
    background: #fee2e2;
    color: #dc2626;
  }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
  }

  .stat-label {
    font-size: 0.875rem;
    color: #64748b;
  }

  /* Sections */
  .section {
    margin-bottom: 2rem;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 1rem;
  }

  .section-header .section-title {
    margin-bottom: 0;
  }

  .view-all {
    color: #f59e0b;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .view-all:hover {
    text-decoration: underline;
  }

  /* Actions Grid */
  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .action-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    text-decoration: none;
    color: inherit;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s;
    border: 2px solid transparent;
  }

  .action-card:hover {
    border-color: #f59e0b;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .action-icon {
    width: 40px;
    height: 40px;
    background: #fef3c7;
    color: #d97706;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .action-icon svg {
    width: 20px;
    height: 20px;
  }

  .action-title {
    font-weight: 600;
    color: #1e293b;
  }

  .action-desc {
    font-size: 0.75rem;
    color: #64748b;
  }

  /* Recent Articles */
  .recent-articles {
    background: white;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .recent-submissions {
    background: white;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .submission-row {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
  }

  .submission-row:last-child {
    border-bottom: none;
  }

  .submission-name {
    font-weight: 600;
    color: #1e293b;
  }

  .submission-message {
    color: #64748b;
    font-size: 0.9rem;
  }

  .submission-meta {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    font-size: 0.75rem;
    color: #94a3b8;
  }

  .submission-source {
    background: #fef3c7;
    color: #b45309;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-weight: 600;
  }

  .loading {
    padding: 2rem;
    text-align: center;
    color: #64748b;
  }

  .article-row {
    display: flex;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    gap: 1.25rem;
    transition: background 0.15s;
  }

  .article-row:last-child {
    border-bottom: none;
  }

  .article-row:hover {
    background: #f8fafc;
  }

  .article-thumb {
    width: 64px;
    height: 48px;
    object-fit: cover;
    border-radius: 0.5rem;
    flex-shrink: 0;
  }

  .article-thumb-placeholder {
    width: 64px;
    height: 48px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-radius: 0.5rem;
    flex-shrink: 0;
  }

  .article-info {
    flex: 1;
    min-width: 0;
  }

  .article-title {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1e293b;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .article-meta {
    font-size: 0.8rem;
    color: #64748b;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .meta-source {
    color: #f59e0b;
    font-weight: 500;
  }

  .meta-category {
    background: #f1f5f9;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
  }

  .meta-date {
    color: #94a3b8;
  }

  .article-status {
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 500;
    flex-shrink: 0;
  }

  .article-status.published {
    background: #d1fae5;
    color: #059669;
  }

  .article-status.draft {
    background: #fef3c7;
    color: #d97706;
  }

  .article-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .btn-edit {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border: none;
    border-radius: 0.5rem;
    color: white;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
  }

  .btn-edit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  }

  .empty-state {
    padding: 3rem;
    text-align: center;
    color: #64748b;
  }

  .empty-state a {
    color: #f59e0b;
    text-decoration: none;
    font-weight: 500;
  }
</style>

<script define:vars={{ apiUrl, apiKey }}>
  const API_URL = apiUrl;
  const API_KEY = apiKey;
  const USE_MOCK = !API_URL;
  const ADMIN_KEY_STORAGE = 'irw_admin_api_key';

  async function fetchAdminArticles() {
    const response = await fetch(`${API_URL}/admin/articles`, {
      headers: { 'X-Api-Key': API_KEY }
    });
    if (!response.ok) throw new Error('Failed to fetch');
    return response.json();
  }

  const getAdminKey = () => localStorage.getItem(ADMIN_KEY_STORAGE) || API_KEY || '';

  async function fetchFormSubmissions(params = {}) {
    const query = new URLSearchParams(params).toString();
    const response = await fetch(`/.netlify/functions/form-submissions${query ? `?${query}` : ''}`, {
      headers: { 'X-Api-Key': getAdminKey() },
    });
    if (!response.ok) throw new Error('Failed to fetch submissions');
    return response.json();
  }

  const escapeHtml = (value = '') =>
    value.replace(/[&<>"']/g, (char) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
    }[char]));

  async function loadDashboard() {
    try {
      let articles;

      if (USE_MOCK) {
        articles = [{ id: '1', title: 'Sample', source: 'Test', category: 'News', status: 'draft', date: new Date().toISOString() }];
      } else {
        const response = await fetchAdminArticles();
        articles = response.articles || [];
      }

      // Update stats
      const published = articles.filter(a => a.status === 'published').length;
      const drafts = articles.filter(a => a.status === 'draft').length;
      const categories = [...new Set(articles.map(a => a.category))].length;

      document.getElementById('total-articles').textContent = articles.length;
      document.getElementById('published-articles').textContent = published;
      document.getElementById('draft-articles').textContent = drafts;
      document.getElementById('categories-count').textContent = categories || 1;

      // Render recent articles
      const recentEl = document.getElementById('recent-articles');
      const recent = articles.slice(0, 5);

      if (recent.length === 0) {
        recentEl.innerHTML = `
          <div class="empty-state">
            No articles yet. <a href="/admin/articles/new">Create your first article</a>
          </div>
        `;
        return;
      }

      recentEl.innerHTML = recent.map(article => {
        const imgUrl = article.featured_image || article.featuredImage;
        return `
          <div class="article-row">
            ${imgUrl ? `<img src="${imgUrl}" alt="" class="article-thumb">` : '<div class="article-thumb-placeholder"></div>'}
            <div class="article-info">
              <div class="article-title">${article.title}</div>
            <div class="article-meta">
              <span class="meta-category">${article.category}</span>
              <span class="meta-date">${new Date(article.date || article.created_at).toLocaleDateString()}</span>
            </div>
            </div>
            <span class="article-status ${article.status}">${article.status}</span>
            <div class="article-actions">
              <a href="/admin/articles/edit?id=${article.id}" class="btn-edit">Edit</a>
            </div>
          </div>
        `;
      }).join('');

      const submissionsContainer = document.getElementById('recent-submissions');
      const submissionsCountEl = document.getElementById('recent-submissions-count');
      try {
        const submissionResponse = await fetchFormSubmissions({ page: 1, perPage: 50 });
        const submissions = Array.isArray(submissionResponse.submissions)
          ? submissionResponse.submissions
          : [];
        const recentSubmissions = submissions.slice(0, 5);

        if (submissionsCountEl) {
          const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
          const recentCount = submissions.filter((entry) => {
            if (!entry.createdAt) return false;
            return new Date(entry.createdAt).getTime() >= sevenDaysAgo;
          }).length;
          submissionsCountEl.textContent = String(recentCount);
        }

        if (submissionsContainer) {
          if (recentSubmissions.length === 0) {
            submissionsContainer.innerHTML = `
              <div class="empty-state">
                No submissions yet. <a href="/press-room">View the form</a>
              </div>
            `;
          } else {
            submissionsContainer.innerHTML = recentSubmissions.map((entry) => `
              <div class="submission-row">
                <div class="submission-name">${escapeHtml(entry.name || 'Anonymous')}</div>
                <div class="submission-message">${escapeHtml(entry.message || 'No message provided.')}</div>
                <div class="submission-meta">
                  <span class="submission-source">${escapeHtml(entry.source || 'unknown')}</span>
                  <span>${entry.createdAt ? new Date(entry.createdAt).toLocaleDateString() : 'Unknown date'}</span>
                </div>
              </div>
            `).join('');
          }
        }
      } catch (error) {
        if (submissionsContainer) {
          submissionsContainer.innerHTML = `
            <div class="empty-state">Failed to load submissions.</div>
          `;
        }
        if (submissionsCountEl) submissionsCountEl.textContent = '-';
      }

    } catch (error) {
      console.error('Failed to load dashboard:', error);
      document.getElementById('recent-articles').innerHTML = `
        <div class="empty-state">Failed to load articles. Please try again.</div>
      `;
    }
  }

  loadDashboard();
</script>
